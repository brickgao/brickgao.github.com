<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" /> 
    <!-- Add jQuery library -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Add mousewheel plugin (this is optional) -->
    <script type="text/javascript" src="/fancybox/lib/jquery.mousewheel-3.0.6.pack.js"></script>
    <!-- Add fancyBox -->
    <link rel="stylesheet" href="/fancybox/source/jquery.fancybox.css?v=2.1.4" type="text/css" media="screen" />
    <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.4"></script>
    <!-- Optionally add helpers - button, thumbnail and/or media -->
    <link rel="stylesheet" href="/fancybox/source/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen" />
    <script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
    <script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-media.js?v=1.0.5"></script>
    <link rel="stylesheet" href="/fancybox/source/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen" />
    <script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
    <script type="text/javascript">
	    $(document).ready(function() {
		    $(".fancybox").fancybox();
	    });
    </script>
    <script type='text/javascript'>
    (function() {
        var c = document.createElement('script'); 
        c.type = 'text/javascript';
        c.async = true;
        c.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'www.clicki.cn/boot/48547';
        var h = document.getElementsByTagName('script')[0];
        h.parentNode.insertBefore(c, h);
    })();
    </script>  
    <meta name="author" content="Brickgao" />
    
    <title>自己写的第一个Chrome Extension</title>
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="Brickgao's" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/style.css">
    <link rel="stylesheet" href="/media/css/github.css">
    <link rel="stylesheet" href="/media/css/fontawesome.css">
    <!--[if IE 7]>
    <link rel="stylesheet" href="/media/css/fontawesome-ie7.css">
    <![endif]-->
    <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="Brickgao's" class="" href="/">Brickgao's</a></h1>
          </div>
          <nav>
            <span><a title="Archive" class="icon-list-ul" href="/archive.html"></a></span>
            <span><a title="Tags" class="icon-tags" href="/tags.html"></a></span>
            <span><a title="About" class="icon-user" href="/about.html"></a></span>
            <span><a title="Blogroll" class="icon-link" href="/links.html"></a></span>
            <span><a title="Subscribe" class="icon-rss" href="/atom.xml"></a></span>
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>自己写的第一个Chrome Extension </h2>
  </section>
  <section class="meta">
  <span class="time">
    <time datetime="2013-05-30">2013-05-30</time>
  </span>
  
  <span class="tags">
    
    <a href="/tags.html#Chrome Extension" title="Chrome Extension">#Chrome Extension</a>
    
    <a href="/tags.html#js" title="js">#js</a>
    
    <a href="/tags.html#Twitter" title="Twitter">#Twitter</a>
    
  </span>
  
  </section>
  <section class="post">
  <p>前几天忽然想写个Chrome Extension玩，于是就动手写了。</p>

<p>也没有特别好的想法，于是写了一个Twitter停留计时和提醒的Extension。</p>

<p>现看了看Chrome的官方文档，后来发现有人自己翻译了一下(<a href="https://crxdoc-zh.appspot.com/extensions/getstarted.html">戳我</a>)，翻译的还不错。</p>

<p>Chrome Extension大概的组成元素是:</p>

<ul>
<li>一个清单文件</li>
<li>一个或多个 HTML 文件（除非扩展程序是一个主题背景）</li>
<li>可选：一个或多个 JavaScript 文件</li>
<li>可选：您的扩展程序需要的任何其他文件，例如图片</li>
</ul>


<p>发现清单列表<code>manifest.json</code>已经发展到了版本二，请务必看下版本二的改动，尤其是安全方面的改动，对于js做了一些限制，比如不能直接内联js等等。</p>

<p>自己写的Extension大概分为两个部分，一个是计时，一个是Time out之后的提醒。</p>

<p>在<code>background.js</code>中的计时部分用了<code>chrome.runtime.onInstalled.addListener</code>在拓展更新的时候来初始化各种变量。</p>

<p>计时模块写个两个函数一个是<code>startTimer()</code>表示启动计时器，另一个<code>endTimer()</code>停止计时器。</p>

<p>计时部分因为对<code>setTimeout("interval();")</code>安全限制，循环改为<code>setTimeout(function() {interval();},1000);</code>。</p>

<p>因为只对当前的页面是不是<code>Twitter.com</code>计时，所以利用以下函数监控<code>Tabs</code>，然后决定是否计时：</p>

<ul>
<li>function checkByTabid(tabId) {} //Check the tab is twitter or not</li>
<li>chrome.tabs.onCreated.addListener(function(tab){}) //Check when create new tab</li>
<li>chrome.tabs.onSelectionChanged.addListener(function(tabId, changeInfo){}) //Check when select tab</li>
<li>chrome.tabs.onRemoved.addListener(function(tabId){}) //Check when change tab</li>
<li>chrome.tabs.onUpdated.addListener(function(tabId, changeInfo){}) //Check when update tab</li>
<li>chrome.windows.onFocusChanged.addListener(function(windowId){}) ////Check when window change</li>
</ul>


<p>不知道为什么参数比较的时候默认成了字符串比较，后来用<code>parseInt</code>函数修改了下。</p>

<p>对于限制时间的设置由HTML5中的<code>localStorage</code>来储存，一开始以为是单个Page拥有独立的<code>localStorage</code>，后来才发现是整个Extension公用，被自己坑了一下。</p>

<p>写桌面通知要在清单中声明可以使用，再对使用的图片声明为可使用的资源，桌面通知大概格式是</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">show</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">notification</span> <span class="o">=</span> <span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">createNotification</span><span class="p">(</span>
        <span class="s1">&#39;icon.png&#39;</span><span class="p">,</span>  <span class="c1">// url of icon</span>
        <span class="s1">&#39;Notice&#39;</span><span class="p">,</span>  <span class="c1">// title of the notice</span>
        <span class="s1">&#39;Time you used on twitter is over toady &gt;_&lt;&#39;</span>  <span class="c1">// the text of notice</span>
    <span class="p">);</span>
    <span class="nx">notification</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<p>写设置不一样的是没法对<code>onclick</code>在<code>button</code>中定义，需要对<code>button</code>的动作监听：</p>

<div class="highlight"><pre><code class="js"><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#saveset&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">save_options</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>


<p>写完发现有个Bug，如果用<code>Gogent</code>来访问Twiiter就会获取<code>tab.url</code>错误，不知道是为什么，之后再研究下。</p>

<p>这次还是新看了不少东西，感觉第一次写Extension，代码风格实在是看不过去。。。</p>

<p>Extension被我扔到Github上了，项目地址<a href="https://github.com/brickgao/twittermaid">https://github.com/brickgao/twittermaid</a></p>

  </section>
  <section class="comment">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'brickgaos'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>
</article>


<section id="page_nav">
  
  <a href='/2013/05/29/code-my-os-3.html'>← Previous</a>
  
  
</section>


        </div>
        <footer>
          <div>
            &copy; Brickgao | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext v">sext v</a> | fork <a href="https://github.com/brickgao/blog" title="fork me">me</a>
          </div>
        </footer>
      </div> <!-- main -->
  </body>
</html>
